/**
 * JavaCC template file created by SF JavaCC plugin 1.5.28+ wizard for JavaCC 1.5.0+
 */
options
{
  static = true;
}

PARSER_BEGIN(miniLeng)

import java.io.*;
import miniLeng.Simbolo;
import miniLeng.Tabla_simbolos;




public class miniLeng
{
  
  static Tabla_simbolos tabla;

  static int nivel;
static int dir;
  public static void main(String args []) throws ParseException
  {
    
      BufferedReader new_buffer = new BufferedReader(new InputStreamReader(System.in));
	  String file;
	  miniLeng parser;
	  dir = 0;
	  
	  System.out.println("Ruta y nombre del fichero:");
	 /* 
	  try
	  {
	    file=new_buffer.readLine();
	  }catch(IOException e) {
	    System.out.println("Error al leer la cadena");
	    return;
	  }
	  */
	  file = "/Users/heru/git/miniLeng-javacc/miniLeng/src/pruebas.txt";
	  System.out.println(file);
	  
	  try {
	    parser = new miniLeng(new FileInputStream(file));
	  }
	  catch(FileNotFoundException e) {
	    System.out.println("Fallo al leer el fichero");
	    return;
	  }

	  parser.tabla = new Tabla_simbolos();
	  parser.tabla.inicializar_tabla();
	  try {
	    parser.programa_completo();
	  }
	  catch (Error e) {
	    	int linea = token.beginLine;
	    int columna = token.beginColumn;
	    String simbolo = token.image;
	    System.out.println("ERROR LÉXICO (<" + linea + ", " + columna + ">): símbolo no reconocido: <" + simbolo + ">");
	    System.out.println("Oops.");
	    System.out.println(e.getMessage());
	  }
	 /* 

		Tabla_simbolos tabla = new Tabla_simbolos();
		//tabla.inicializar_tabla();

		tabla.introducir_programa("pepe", 0);

		Simbolo esta = tabla.buscar_simbolo("pepe");

		Simbolo esta2 = tabla.buscar_simbolo("pepa");

		Simbolo s1 = tabla.introducir_variable("a",Simbolo.TipoVariable.ENTERO, 0, 0);
		Simbolo s2 = tabla.introducir_variable("a",Simbolo.TipoVariable.ENTERO, 1, 0);
		Simbolo s3 = tabla.introducir_variable("a",Simbolo.TipoVariable.ENTERO, 0, 0);
		Simbolo s4 = tabla.introducir_variable("b",Simbolo.TipoVariable.ENTERO, 0, 0);
		
		tabla.eliminar_variables(1);
		tabla.eliminar_variables(0);
		tabla.eliminar_programa();
		


		int x = 3+2;
	*/
  }
  /********** Tratamiento Errores **********************/
  public static void tratarErrorSintactico(int line, int column, String msg_error) {
	System.out.println("ERROR SINTACTICO (<" + line + ", " + column + ">): Simbolo encontrado \"" + msg_error + "\"");
  }
  public static void errorSemantico(String msg_error) {
	System.out.println(msg_error);
  }

}

  
PARSER_END(miniLeng)


void programa_completo():
{}
{
  programa() < EOF >
}


/*  programa ::= < tPROGRAMA > <tIDENTIFICADOR > ";"
					declaracion_variables
					declaracion_acciones
					bloque_sentencias             */
void programa() : 
{ Token t1, t2 = null; }
{
  try { 
	<tPROGRAMA> t1 = <tIDENTIFICADOR> ";"
	{
	  tabla.introducir_programa(t1.image, 0);
	  nivel = 0;
	}
	declaracion_variables() declaracion_acciones()
	bloque_sentencias()
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}


/* declaracion_variables ::= (declaracion ";")* */
void declaracion_variables() : 
{}
{
  try { 
    (declaracion() ";")*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}


/* declaracion ::= tipo_variables identificadores */
void declaracion() : 
{Simbolo.TipoVariable tipoVar;}
{
  try { 
    tipoVar = tipo_variables() identificadores(tipoVar)
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());       
  }
}

/* tipo_variables ::= < tENTERO > | < tCARACTER > | < tBOOLEANO > */
Simbolo.TipoVariable tipo_variables() : 
{}
{
  try { 
    < tENTERO >    { return Simbolo.TipoVariable.ENTERO; }
|   < tCARACTER >  { return Simbolo.TipoVariable.ENTERO; }
|   < tBOOLEANO >  { return Simbolo.TipoVariable.ENTERO; }
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}


/* identificadores ::= < tIDENTIFICADOR > ( "," < tIDENTIFICADOR >)* */
void identificadores(Simbolo.TipoVariable tipoVar) : 
{ Token t1,t2; }
{
  try { 
    t1 = < tIDENTIFICADOR >
	{
		if ( tabla.buscar_simbolo(t1.image) != null) 
		    miniLeng.errorSemantico("Identificador duplicado");
		else 
			tabla.introducir_variable(t1.image, tipoVar, nivel, dir);
	}
     ( "," < tIDENTIFICADOR> )*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());       
  }
}

/***************************************************************************************************
***************************************************************************************************/
/* ******* Acciones *****/

/* declaracion_acciones ::= (declaracion_accion)* */
void declaracion_acciones() : 
{}
{
  try { 
    ( declaracion_accion() )*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());       
  }
}


/* declaracion_accion ::= cabecera_accion ";"
							declaracion_variables
							declarracion_acciones
							bloque sentencias	*/
void declaracion_accion() : 
{}
{
  try { 
    cabecera_accion() ";"
	declaracion_variables() 
	declaracion_acciones() 
	bloque_sentencias()
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());  
  }
}

/* cabecera_accion ::= < tACCION > < tIDENTIFICADOR > parametros_formales() */
void cabecera_accion() : 
{}
{
  try { 
    < tACCION > < tIDENTIFICADOR > parametros_formales()
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* parametros_formales ::= ( "(" parametros ")")? */
void parametros_formales() : 
{}
{
  try { 
	( "(" parametros() ")")?
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());  
  }
}

/* lista_parametros ::= identificadores (";" paraemtros)? */
void lista_parametros(Simbolo.TipoVariable tipoVar) : 
{}
{
  try { 
    identificadores(tipoVar) ( ";" parametros())?
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* parametros ::= clase_parametros tipo_variables lista_parametros */
void parametros() : 
{ Simbolo.TipoVariable tipoVar; }
{
  try { 
    clase_parametros() tipoVar = tipo_variables() lista_parametros(tipoVar)
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}


/* clase_parametros ::= < tVAL > | < tREF > */
void clase_parametros() : 
{}
{
  try { 
    < tVAL >
 |  < tREF >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}

/***************************************************************************************************
***************************************************************************************************/
/* ******* Sentencias *****/


/* bloque_sentencias ::= < tPRINCIPIO > lista_sentencias < tFIN > */
void bloque_sentencias() : 
{}
{
  try { 
    < tPRINCIPIO > lista_sentencias() < tFIN >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}


/* lista_sentencias ::= ( sentencia )* */
void lista_sentencias() : 
{}
{
  try { 
    ( sentencia() )*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* sentencia ::= asignacion | invoacion_accion | mientras_que | leer | escribir | selecion */
void sentencia() : 
{}
{
  try { 
	  < tIDENTIFICADOR >
	 [ 
		   asignacion()
		 | invocacion_accion()
	 ]
	| mientras_que()
	| leer() ";"
	| escribir() ";"
	| seleccion()
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}

/* asignacion ::= < tOPAS > expresion ";" */
void asignacion() : 
{}
{
  try { 
     < tOPAS > expresion() ";"
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());  
  }
}

/* invocacion_accion ::= argumentos ";" */
void invocacion_accion() :
{}
{
  try { 
	 argumentos() ";"
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}

/* mientras_que ::= < tMQ > expresion lista_sentencias < tFMQ > */
void mientras_que() :
{}
{
  try { 
   < tMQ > expresion() lista_sentencias() < tFMQ >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* seleccion ::= < tSI > expresion < tENT > lista_sentencias ( < tSI_NO > lista_sentencias )* < tFSI > */
void seleccion() :
{}
{
  try { 
	< tSI > expresion() < tENT > lista_sentencias() (< tSI_NO > lista_sentencias())*< tFSI >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage()); 
  }
}

/* leer ::= < tLEER > "(" lista_asinables ")" */
void leer() :
{}
{
  try { 
   <tLEER> "(" lista_asignables() ")"
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* escribir ::= < tESCRIBIR > "(" lista_escribibles ")" */
void escribir() :
{}
{
  try { 
   <tESCRIBIR> "(" lista_escribibles() ")"
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}

/* lista_asinables ::= identificadores */
void lista_asignables() :
{}
{
  try { 
  	< tIDENTIFICADOR> ( "," < tIDENTIFICADOR> )*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}

/* lista_escribibles ::= (< tCONSTCAD > | < tCONSTCHAR >) ( "," (< tIDENTIFICADOR >  |  < tENTACAR > "(" expresion ")" ) )* */
void lista_escribibles() : 
{}
{
  try { 
  (< tCONSTCAD > | < tCONSTCHAR >) ( "," (< tIDENTIFICADOR >  |  < tENTACAR > "(" expresion() ")" ) )*
  }
  catch (Exception e) {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}



/* argumentos ::= ( "(" lista_expresiones ")" )? */
void argumentos() : 
{}
{
  try { 
    ( "(" lista_expresiones() ")")?
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());    
  }
}

/* lista_expresiones ::= expresion ( "," expresion)* */
void lista_expresiones() : 
{}
{
  try { 
    expresion() ( "," expresion())*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}

/* expresion ::= expresion_simple | (operador_relacional expresion_simple)* */
void expresion() : 
{}
{
  try { 
	expresion_simple()
	 (operador_relacional() expresion_simple())*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());       
  }
}

/* expresion_simple ::= termino (operador_aditivo termino)* */
void expresion_simple() : 
{}
{
  try { 
	termino() ( operador_aditivo() termino())*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}


void operador_relacional() : 
{}
{
  try { 
    	< tMAYOR >
  | 	< tMENOR >
  | 	< tIGUAL >
  | 	< tMAI >
  | 	< tMEI  >
  | 	< tNI >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}


void operador_aditivo() : 
{}
{
  try { 
    "+" | "-" | < tOR >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());     
  }
}

void operador_multiplicativo() : 
{}
{
  try { 
    "*" | < tDIV > |  < tMOD > | < tAND >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());      
  }
}

/* termino ::= factor (operador multiplicativo factor)* */
void termino() : 
{}
{
  try { 
    factor() (operador_multiplicativo()  factor())*
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());   
  }
}


void factor() : 
{}
{
  try { 
    "-" factor()
 |  < tNOT > factor()
 |  "(" expresion() ")"
 |  < tENTACAR > "(" expresion() ")"
 |  < tCARAENT > "(" expresion() ")"
 |  < tIDENTIFICADOR >
 |  < tCONSTCHAR >
 |  < tCONSTCAD >
 |  < tCONSTENTERA >
 |  < tTRUE >
 |  < tFALSE >
  }
  catch (Exception e)
  {
	miniLeng.tratarErrorSintactico(token.next.beginLine, token.next.beginColumn, token.next.image);
	System.out.println(e.getMessage());   
  }
}


SKIP :
{
  " "
| "\r"
| "\t"
| "\n"
| "%" : COMMENT 
}

< COMMENT > SKIP :
{
  "\n" : DEFAULT
}

<COMMENT> MORE : {
	<~[]>
}

TOKEN : /*  Reservadas */
{
	< tPROGRAMA : "programa" > { System.out.println("tPROGRAMA reconocido"); }
| 	< tVAR : "var" >
| 	< tAND: "and" >
| 	< tOR: "or" >
| 	< tNOT: "not" >
| 	< tPRINCIPIO : "principio" > { System.out.println("Principio reconocido"); } 
| 	< tFIN: "fin" > { System.out.println("Fin reconocido"); }
| 	< tSI: "si" >
| 	< tENT: "ent" >
| 	< tSI_NO : "si_no" >
| 	< tFSI: "fsi" >
| 	< tMQ: "mq" >
| 	< tFMQ: "fmq" >
| 	< tESCRIBIR : "escribir" >
| 	< tLEER: "leer" >
| 	< tMOD: "mod" >
| 	< tDIV: "div" >
| 	< tENTERO: "entero" >
| 	< tBOOLEANO: "booleano" >
| 	< tCARACTER : "caracter" >
| 	< tTRUE: "true" >
| 	< tFALSE: "false" >
| 	< tENTACAR: "entacar" >
| 	< tCARAENT: "caraent" >
| 	< tACCION: "accion" >
| 	< tVAL : "val" >
| 	< tREF: "ref" >
| 	< tMAYOR: ">" >
| 	< tMENOR: "<" >
| 	< tIGUAL: "=" >
| 	< tMAI: ">=" >
| 	< tMEI : "<=" >
| 	< tNI: "<>" >
| 	< tOPAS: ":=" >
}

TOKEN :   /* Digits */
{
  < tCONSTENTERA : (< DIGIT >)+ >
| < tREAL : (< DIGIT >)+ "." (< DIGIT >)+ >
| < #DIGIT : [ "0"-"9" ] >
}


TOKEN : {
 < tIDENTIFICADOR: <LETTER> ((<LETTER> | <DIGIT>)* (["A"-"Z","a"-"z","0"-"9"]) )? >
| < #LETTER: ["A"-"Z","_","a"-"z"] >
| < tCONSTCHAR : "\'"  (~["\'","\\","\n","\r"] |  "\\" ["n","t","b","r","f","\\","\'","\""])*  "\'" >
| < tCONSTCAD  : "\""  (~["\'","\\","\n","\r"] |  "\\" ["n","t","b","r","f","\\","\'","\""])*  "\"" >
}


